/*
База данных содержит список аэропортов практически всех крупных городов России.
 В большинстве городов есть только один аэропорт. Исключение составляет:
*/

SELECT a.city,
      count(a.airport_code)
FROM dst_project.airports a
GROUP BY city
having count(a.airport_code) > 1

Задание 4.2

/*
Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и 
запланированных рейсах. Сколько всего статусов для рейсов определено в таблице?
*/

SELECT count(DISTINCT f.status)
FROM dst_project.flights f
	
/*
Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в 
базе (статус рейса «самолёт уже вылетел и находится в воздухе»).
*/

SELECT count(f.flight_id)
FROM dst_project.flights f
WHERE f.status = 'Departed'

/*
Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет 
самолет модели  (Boeing 777-300)?
*/

SELECT count(DISTINCT s.seat_no)
FROM dst_project.aircrafts a
JOIN dst_project.seats s ON a.aircraft_code = s.aircraft_code
WHERE a.model = 'Boeing 777-300'

/*
Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 
1 апреля 2017 года и 1 сентября 2017 года?
*/

ELECT count(f.flight_id)
FROM dst_project.flights f
WHERE f.status = 'Arrived'
  AND (f.actual_arrival BETWEEN '2017-04-01' AND '2017-09-01')

Задание 4.3

/*
Вопрос 1. Сколько всего рейсов было отменено по данным базы?
*/

SELECT count(f.flight_id)
FROM dst_project.flights f
WHERE f.status = 'Cancelled'

/*
Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet,
 Airbus находится в базе авиаперевозок?
*/

SELECT 'Boeing' model_fly,
                count(DISTINCT a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model like '%Boeing%'
UNION
SELECT 'Sukhoi Superjet' model_fly,
                         count(DISTINCT a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model like '%Sukhoi Superjet%'
UNION
SELECT 'Airbus' model_fly,
                count(DISTINCT a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model like '%Airbus%''

/*
Вопрос 3. В какой части (частях) света находится больше аэропортов?
*/

SELECT 'Europe' timezone,
                count(a.airport_code)
FROM dst_project.airports a
WHERE a.timezone like '%Europe%'
UNION
SELECT 'Asia' timezone,
              count(a.airport_code)
FROM dst_project.airports a
WHERE a.timezone like '%Asia%'
UNION
SELECT 'Australia' timezone,
                   count(a.airport_code)
FROM dst_project.airports a
WHERE a.timezone like '%Australia%'

/*
Вопрос 4. У какого рейса была самая большая задержка прибытия за все 
время сбора данных? Введите id рейса (flight_id).
*/
SELECT t1.flight_id
FROM
  (SELECT f.flight_id,
          f.scheduled_arrival - f.actual_arrival dif_time
   FROM dst_project.flights f
   ORDER BY dif_time) t1
LIMIT 1

Задание 4.4

/*
Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?
*/

SELECT f.scheduled_departure
FROM dst_project.flights f
ORDER BY 1
LIMIT 1

/*
Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?
*/

SELECT EXTRACT (HOUR
                FROM (f.scheduled_arrival - f.scheduled_departure)*60) long_fly
FROM dst_project.flights f
ORDER BY long_fly DESC
LIMIT 1

/*
Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?
*/

SELECT t2.departure_airport,
       t2.arrival_airport
FROM
  (SELECT f.departure_airport,
          f.arrival_airport,
          EXTRACT (HOUR
                   FROM (f.scheduled_arrival - f.scheduled_departure)*60) long_fly
   FROM dst_project.flights f
   ORDER BY long_fly DESC
   LIMIT 1) t2

/*
Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? 
Секунды округляются в меньшую сторону (отбрасываются до минут).
*/

SELECT round(avg(t2.long_fly))
FROM
  (SELECT EXTRACT (HOUR
                   FROM (f.scheduled_arrival - f.scheduled_departure)*60) long_fly
   FROM dst_project.flights f
   ORDER BY long_fly) t2

Задание 4.5

/*
Вопрос 1. Мест какого класса у SU9 больше всего?
*/

SELECT s.fare_conditions,
       count(s.fare_conditions)
FROM dst_project.SEATS s
WHERE s.aircraft_code = 'SU9'
GROUP BY s.fare_conditions

/*
Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?
*/

SELECT min(b.total_amount)
FROM dst_project.bookings b

/*
Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?
*/

SELECT seat_no
FROM dst_project.boarding_passes b
JOIN dst_project.tickets t ON b.ticket_no = t.ticket_no
WHERE t.passenger_id = '4313 788533'

Задание 5.1

/*
Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?
*/
SELECT count(*)
FROM dst_project.flights fl
JOIN dst_project.airports a ON fl.arrival_airport = a.airport_code
WHERE a.city = 'Anapa'
  AND EXTRACT (YEAR
               FROM fl.actual_arrival) = '2017'

/*
Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?
*/

SELECT count(*)
FROM dst_project.flights fl
JOIN dst_project.airports a ON fl.departure_airport = a.airport_code
WHERE a.city = 'Anapa'
  AND EXTRACT (YEAR
               FROM fl.actual_arrival) = '2017'
  AND (EXTRACT (MONTH
                FROM fl.actual_arrival) NOT BETWEEN '03' AND '11')


/*
Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.
*/

SELECT count(*)
FROM dst_project.flights fl
JOIN dst_project.airports a ON fl.departure_airport = a.airport_code
WHERE a.city = 'Anapa'
  AND fl.status = 'Cancelled'

/*
Вопрос 4. Сколько рейсов из Анапы не летают в Москву?
*/

SELECT count(*)
FROM dst_project.flights fl
JOIN dst_project.airports a ON fl.arrival_airport = a.airport_code
WHERE fl.departure_airport = 'AAQ'
  AND city != 'Moscow'

/*
Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?
*/

SELECT a.model,
       count(DISTINCT s.seat_no)
FROM dst_project.flights fl
JOIN dst_project.aircrafts a ON fl.aircraft_code = a.aircraft_code
JOIN dst_project.seats s ON fl.aircraft_code = s.aircraft_code
WHERE fl.departure_airport = 'AAQ'
GROUP BY a.model


Project 4 

SELECT sub_1.model,
       sub_1.aircraft_code,
       sub_1.range,
       sub_1.all_seats,
       sub_2.occupied_seats,
       sub_2.occupied_seats*1.0/sub_1.all_seats occupancy_air,
       sub_2.flight_id,
       sub_2.sum_amount,
       fl.scheduled_departure,
       fl.scheduled_arrival,
       fl.departure_airport,
       fl.arrival_airport,
       fl.actual_departure,
       fl.actual_arrival,
       fl.actual_arrival - fl.actual_departure time_fly,
       sub_3.city,
       sub_3.airport_name,
       sub_3.longitude,
       sub_3.latitude
FROM
  (SELECT a.model,
          a.aircraft_code,
          a.range,
          count(DISTINCT s.seat_no) all_seats -- add how many seats in model

   FROM dst_project.aircrafts a
   JOIN dst_project.seats s ON a.aircraft_code = s.aircraft_code
   GROUP BY a.model,
            a.aircraft_code)sub_1
JOIN dst_project.flights fl ON sub_1.aircraft_code = fl.aircraft_code
JOIN /*
how many seats occupied in aircraft
*/
  (SELECT tf.flight_id,
          count(tf.ticket_no) occupied_seats,
          sum(tf.amount) sum_amount
   FROM dst_project.ticket_flights tf
   GROUP BY tf.flight_id) sub_2 ON fl.flight_id = sub_2.flight_id
JOIN /* add city, latitude, longitude (Anapa has longitude = 37.35, latitude = 45)
*/
  (SELECT a.city,
          a.airport_name,
          a.longitude,
          a.latitude,
          a.airport_code
   FROM dst_project.airports a) sub_3 ON fl.arrival_airport = sub_3.airport_code
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01',
                                                    '2017-02-01',
                                                    '2017-12-01'))
  AND status not in ('Cancelled') 

/*
В этоге мы получили 118 рейсов. Поскольку отсутствуют данные по количеству мест
 и оплаты рейса Анапа - Новокузнецк в зимний период. А значит остальная информация по нему просто бесполезна. 
Также при необходимости можно всегда вывести все 127 рейсов используя этот код:
*/



SELECT sub_1.model,
       sub_1.aircraft_code,
       sub_1.range,
       sub_1.all_seats,
       sub_2.occupied_seats,
       round(sub_2.occupied_seats*1.0/sub_1.all_seats, 2) occupancy_air,
       sub_2.flight_id,
       sub_2.sum_amount,
       fl.scheduled_departure,
       fl.scheduled_arrival,
       fl.departure_airport,
       fl.arrival_airport,
       fl.actual_departure,
       fl.actual_arrival,
       fl.actual_arrival - fl.actual_departure time_fly,
       sub_3.city,
       sub_3.airport_name,
       sub_3.longitude,
       sub_3.latitude
FROM
  (SELECT a.model,
          a.aircraft_code,
          a.range,
          count(DISTINCT s.seat_no) all_seats -- add how many seats in model

   FROM dst_project.aircrafts a
   JOIN dst_project.seats s ON a.aircraft_code = s.aircraft_code
   GROUP BY a.model,
            a.aircraft_code)sub_1
JOIN dst_project.flights fl ON sub_1.aircraft_code = fl.aircraft_code
LEFT JOIN /*
how many seats occupied in aircraft
*/
  (SELECT tf.flight_id,
          count(tf.ticket_no) occupied_seats,
          sum(tf.amount) sum_amount
   FROM dst_project.ticket_flights tf
   GROUP BY tf.flight_id) sub_2 ON fl.flight_id = sub_2.flight_id
JOIN /* add city, latitude, longitude (Anapa has longitude = 37.35, latitude = 45)
*/
  (SELECT a.city,
          a.airport_name,
          a.longitude,
          a.latitude,
          a.airport_code
   FROM dst_project.airports a) sub_3 ON fl.arrival_airport = sub_3.airport_code
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01',
                                                    '2017-02-01',
                                                    '2017-12-01'))
  AND status not in ('Cancelled')
























